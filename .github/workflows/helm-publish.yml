name: Helm Chart Publish

on:
  push:
    branches: [ main ]
    paths:
      - 'helm/**'
      - '.github/helm-version.txt'
      - '.github/workflows/helm-publish.yml'
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (major, minor, patch)'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch

env:
  REGISTRY: ghcr.io
  CHART_NAME: go-app

permissions:
  contents: write
  packages: write

jobs:
  publish-helm-chart:
    name: Package and Publish Helm Chart
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Read current Helm version
      id: current_version
      run: |
        HELM_VERSION=$(cat .github/helm-version.txt)
        echo "version=$HELM_VERSION" >> $GITHUB_OUTPUT
        echo "Current Helm chart version: $HELM_VERSION"

    - name: Calculate new version
      id: new_version
      run: |
        CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
        BUMP_TYPE="${{ github.event.inputs.version_bump || 'patch' }}"

        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"

        case $BUMP_TYPE in
          major)
            major=$((major + 1))
            minor=0
            patch=0
            ;;
          minor)
            minor=$((minor + 1))
            patch=0
            ;;
          patch)
            patch=$((patch + 1))
            ;;
        esac

        NEW_VERSION="$major.$minor.$patch"
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New Helm chart version: $NEW_VERSION"

    - name: Update Helm chart version
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.version }}"

        # Update Chart.yaml
        sed -i "s/^version:.*/version: $NEW_VERSION/" helm/go-app/Chart.yaml

        # Update version tracking file
        echo "$NEW_VERSION" > .github/helm-version.txt

        echo "Updated Chart.yaml and helm-version.txt to version $NEW_VERSION"

    - name: Lint Helm chart
      run: helm lint ./helm/go-app

    - name: Package Helm chart
      run: |
        mkdir -p .helm-repo
        helm package ./helm/go-app -d .helm-repo
        echo "Packaged chart:"
        ls -la .helm-repo/

    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

    - name: Push Helm chart to OCI registry
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.version }}"
        CHART_PACKAGE=".helm-repo/${{ env.CHART_NAME }}-${NEW_VERSION}.tgz"

        helm push "$CHART_PACKAGE" oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts

        echo "Pushed Helm chart version $NEW_VERSION to OCI registry"

    - name: Generate chart index
      run: |
        helm repo index .helm-repo --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts

    - name: Commit version bump
      if: github.event_name != 'pull_request'
      run: |
        git add helm/go-app/Chart.yaml .github/helm-version.txt
        git commit -m "chore: bump Helm chart version to ${{ steps.new_version.outputs.version }} [skip ci]" || echo "No changes to commit"
        git push origin main || echo "Nothing to push"

    - name: Create GitHub Release for Helm Chart
      uses: softprops/action-gh-release@v2
      if: github.event_name != 'pull_request'
      with:
        tag_name: helm-v${{ steps.new_version.outputs.version }}
        name: Helm Chart v${{ steps.new_version.outputs.version }}
        body: |
          ## Helm Chart Release v${{ steps.new_version.outputs.version }}

          ### Installation

          ```bash
          # Install from OCI registry
          helm install go-app oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/go-app --version ${{ steps.new_version.outputs.version }}

          # Or download the chart package
          helm pull oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/go-app --version ${{ steps.new_version.outputs.version }}
          ```

          ### What's Changed

          Helm chart version: `${{ steps.new_version.outputs.version }}`
          Application version: `${{ steps.current_version.outputs.version }}`

          See [README](https://github.com/${{ github.repository }}/blob/main/helm/go-app/README.md) for full documentation.
        files: |
          .helm-repo/*.tgz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Helm chart as artifact
      uses: actions/upload-artifact@v4
      with:
        name: helm-chart-${{ steps.new_version.outputs.version }}
        path: .helm-repo/*.tgz
        retention-days: 90

    - name: Summary
      run: |
        echo "### Helm Chart Published Successfully! :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Chart Version:** ${{ steps.new_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Chart Name:** ${{ env.CHART_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Installation Command:**" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "helm install go-app oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/go-app --version ${{ steps.new_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
